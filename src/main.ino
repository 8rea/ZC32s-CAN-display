#include <SPI.h>
#include <mcp2515.h>
#include <Adafruit_NeoPixel.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Preferences.h>

// -------------------- Pin Definitions --------------------
#define CAN_CS    5
#define SPI_SCK   18
#define SPI_MISO  19
#define SPI_MOSI  23
#define LED_PIN   15
#define NUM_LEDS  10

// --- ROTARY ENCODER PINS ---
#define ENC_CLK   32  // S1
#define ENC_DT    33  // S2
#define ENC_SW    25  // KEY

// -------------------- CAN IDs --------------------
#define RPM_CAN_ID       0x124
#define WHEEL_CAN_ID     0x1B8
#define COOLANT_CAN_ID   0x310
#define ACCEL_CAN_ID     0x122

// -------------------- Global Variables --------------------
struct can_frame canMsg;
MCP2515 CAN0(CAN_CS);

// --- NEOPIXEL ---
Adafruit_NeoPixel leds(NUM_LEDS, LED_PIN, NEO_GRB + NEO_KHZ800);
Preferences prefs; 

unsigned int rpm = 0;
unsigned int rpmreal = 0;
int wheelSpeed = 0;
int coolantTemp = 0;
int accelPedal = 0;

unsigned long lastDisplayUpdate = 0;
unsigned long lastCANtime = 0;
const unsigned long displayInterval = 50; 

// -------------------- Settings & Menu Variables --------------------
int redline = 6500;
int displayMode = 0;
int ledBrightness = 20;    // 0-255
int ledDirection = 0;      // 0 = Left->Right, 1 = Right->Left
int flashSpeed = 100;      // ms delay for strobe (Lower = Faster)

// Menu Logic
enum State { STATE_MAIN, STATE_SET_REDLINE, STATE_SET_BRIGHTNESS, STATE_SET_DIRECTION, STATE_SET_FLASH };
State currentState = STATE_MAIN;

// --- ROBUST ENCODER VARIABLES ---
volatile int encoderRawValue = 0; 
int lastEncoderValue = 0; 

// --- BUTTON & RESET VARIABLES (OPTIMIZED) ---
// These capture the timing for Short Click vs Long Press
unsigned long buttonDownTime = 0;     
bool isLongPressHandled = false;      
const unsigned long longPressDuration = 3000; // 2 seconds to hold for reset
unsigned long lastMenuActionTime = 0;

// -------------------- OLED --------------------
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// -------------------- Bitmaps --------------------
// 'New Project' Logo
const unsigned char logo_bmp [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x08, 0x20, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x04, 0x40, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x02, 0x87, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x01, 0x04, 0x00, 0x03, 0x00, 0x00, 0x0e, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x01, 0x06, 0x00, 0x01, 0x00, 0x00, 0x03, 0x87, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x02, 0x03, 0x00, 0x01, 0x80, 0x00, 0x00, 0xe1, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x04, 0x01, 0x80, 0x01, 0x80, 0x00, 0x00, 0x30, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x08, 0x00, 0xc0, 0x00, 0x80, 0x00, 0x00, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x10, 0x00, 0x60, 0x00, 0x80, 0x00, 0x00, 0x0c, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x20, 0x00, 0x30, 0x00, 0xc0, 0x00, 0x00, 0x06, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x40, 0x00, 0x18, 0x00, 0x40, 0x00, 0x00, 0x1f, 0xc3, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0xfe, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc1, 0x80, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x01, 0xc1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x03, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf0, 0x00, 0x00, 0x00, 
  0x00, 0x02, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 
  0x00, 0x02, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 
  0x00, 0x04, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x78, 0x00, 0x00, 
  0x00, 0x04, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x0c, 0x00, 0x00, 
  0x00, 0x0f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x83, 0x00, 0x00, 
  0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0x00, 0x00, 
  0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x80, 0x00, 
  0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x40, 0x00, 
  0x00, 0x18, 0x03, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x07, 0xc0, 0x00, 
  0x00, 0x10, 0x04, 0xf9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0xe4, 0x00, 0x20, 0x00, 
  0x00, 0x10, 0x0b, 0xfe, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2f, 0xfa, 0x00, 0xd0, 0x00, 
  0x00, 0x10, 0x17, 0x27, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5c, 0x9d, 0x00, 0x78, 0x00, 
  0x00, 0x10, 0x2f, 0x27, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xbc, 0x9e, 0x80, 0x08, 0x00, 
  0x00, 0x10, 0x4c, 0xa9, 0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x72, 0xa7, 0x40, 0x0c, 0x00, 
  0x00, 0x10, 0x9c, 0xa9, 0xc8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x72, 0xa7, 0x21, 0xfc, 0x00, 
  0x00, 0x30, 0xb3, 0x76, 0x68, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xcd, 0xd9, 0xa1, 0x0c, 0x00, 
  0x00, 0x30, 0xb0, 0xf8, 0x68, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xc3, 0xe1, 0xa1, 0x7c, 0x00, 
  0x00, 0x30, 0xbf, 0xff, 0xe8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xff, 0xff, 0xa0, 0xa4, 0x00, 
  0x00, 0x18, 0xb0, 0xf8, 0x68, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xc3, 0xe1, 0xa0, 0xbc, 0x00, 
  0x00, 0x0c, 0xb3, 0x76, 0x68, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xcd, 0xd9, 0xa0, 0xc4, 0x00, 
  0x00, 0x07, 0x9c, 0xa9, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x72, 0xa7, 0x38, 0x7c, 0x00, 
  0x00, 0x01, 0x9c, 0xa9, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x72, 0xa7, 0x3f, 0xf8, 0x00, 
  0x00, 0x00, 0x0f, 0x2f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0xbe, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x07, 0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x9c, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x03, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xe0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Placeholder for RPM Gauge (128x64)
// REPLACE this with your actual byte array from image2cpp
const unsigned char epd_bitmap_rpm_gauge[1024] PROGMEM = {
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x3f, 0xc1, 0x81, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfe, 0x3f, 0xe3, 0x81, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0x3f, 0xf3, 0x83, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x38, 0x7b, 0xc7, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0x03, 0x38, 0x3b, 0xef, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0x03, 0x38, 0x3b, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x38, 0x7b, 0xbd, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfe, 0x3f, 0xf3, 0x99, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x3f, 0xe3, 0x99, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0x78, 0x38, 0x03, 0x81, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0x3c, 0x38, 0x03, 0x81, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0x1e, 0x38, 0x03, 0x81, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0f, 0x38, 0x03, 0x81, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x38, 0x03, 0x81, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0x03, 0x38, 0x03, 0x81, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x83, 0x80, 0x04, 0x00, 0x1c, 0x00, 0x78, 0x00, 0x10, 0x00, 0x3e, 0x00, 0x07, 0x00, 0x01, 0xf1, 
  0x84, 0x40, 0x0c, 0x00, 0x22, 0x00, 0x04, 0x00, 0x30, 0x00, 0x20, 0x00, 0x08, 0x80, 0x01, 0x11, 
  0x84, 0x40, 0x14, 0x00, 0x22, 0x00, 0x04, 0x00, 0x50, 0x00, 0x20, 0x00, 0x08, 0x80, 0x01, 0x11, 
  0x84, 0x40, 0x04, 0x00, 0x02, 0x00, 0x04, 0x00, 0x50, 0x00, 0x3c, 0x00, 0x08, 0x00, 0x00, 0x11, 
  0x84, 0x40, 0x04, 0x00, 0x04, 0x00, 0x38, 0x00, 0x90, 0x00, 0x02, 0x00, 0x0f, 0x00, 0x00, 0x21, 
  0x84, 0x40, 0x04, 0x00, 0x08, 0x00, 0x04, 0x00, 0x90, 0x00, 0x02, 0x00, 0x08, 0x80, 0x00, 0x41, 
  0x84, 0x40, 0x04, 0x00, 0x10, 0x00, 0x04, 0x00, 0xf8, 0x00, 0x22, 0x00, 0x08, 0x80, 0x00, 0xc1, 
  0x84, 0x40, 0x04, 0x00, 0x20, 0x00, 0x04, 0x00, 0x10, 0x00, 0x22, 0x00, 0x08, 0x80, 0x00, 0x81, 
  0x83, 0x80, 0x1f, 0x00, 0x3e, 0x00, 0x78, 0x00, 0x10, 0x00, 0x1c, 0x00, 0x07, 0x00, 0x00, 0x81, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x25, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x01, 0x13, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x05, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x4b, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x05, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x01, 0x13, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x05, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x4b, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x25, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x01, 0x13, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x05, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x4b, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x05, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x01, 0x13, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x25, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x4b, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x05, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x01, 0x13, 0xc1, 
  0x81, 0x00, 0x04, 0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08, 0x00, 0x02, 0x00, 0x05, 0xc1, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

// -------------------- INTERRUPT: ROBUST STATE TABLE --------------------
const int8_t encoder_states[] = {0,-1,1,0,1,0,0,-1,-1,0,0,1,0,1,-1,0};

void IRAM_ATTR readEncoderISR() {
  static uint8_t old_AB = 0;
  old_AB <<= 2;
  old_AB |= ( (digitalRead(ENC_DT) << 1) | digitalRead(ENC_CLK) ); 
  old_AB &= 0x0f; 
  int change = encoder_states[old_AB];
  if (change != 0) {
    encoderRawValue += change; 
  }
}

int centerTextX(String text, int textSize = 1) {
  int16_t x1, y1;
  uint16_t w, h;
  display.setTextSize(textSize);
  display.getTextBounds(text, 0, 0, &x1, &y1, &w, &h);
  return (SCREEN_WIDTH - w) / 2;
}

void saveSettings() {
  prefs.begin("dash", false); 
  prefs.putInt("redline", redline);
  prefs.putInt("mode", displayMode);
  prefs.putInt("bright", ledBrightness);
  prefs.putInt("dir", ledDirection);
  prefs.putInt("flash", flashSpeed);
  prefs.end();
}

void loadSettings() {
  prefs.begin("dash", true); 
  redline = prefs.getInt("redline", 6500);
  displayMode = prefs.getInt("mode", 0);
  ledBrightness = prefs.getInt("bright", 20);
  ledDirection = prefs.getInt("dir", 0);
  flashSpeed = prefs.getInt("flash", 100);
  prefs.end();

  leds.setBrightness(ledBrightness);
}

void showMenu() {
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(SSD1306_WHITE);
  String header = "";
  String value = "";
  switch (currentState) {
    case STATE_SET_REDLINE:
      header = "SET RPM";
      value = String(redline);
      break;
    case STATE_SET_BRIGHTNESS:
      header = "BRIGHTNESS";
      value = String(ledBrightness);
      break;
    case STATE_SET_DIRECTION:
      header = "LED DIR";
      value = (ledDirection == 0) ? "L->R" : "R->L";
      break;
    case STATE_SET_FLASH:
      header = "FLASH MS";
      value = String(flashSpeed) + "ms";
      break;
  }
  int xH = centerTextX(header, 2);
  display.setCursor(xH, 5);
  display.print(header);
  display.setTextSize(1);
  display.setCursor(10, 55);
  display.print("< Rotate >");
  display.setTextSize(3);
  int xV = centerTextX(value, 3);
  display.setCursor(xV, 28);
  display.print(value);
  display.display();
}

void showDisplay(int rpmreal, int wheelSpeed, int coolantTemp, int accelPedal) {
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(SSD1306_WHITE);
  switch (displayMode) {
    case 0:
      display.setCursor(0, 0);
      display.print("RPM:");  display.println(rpmreal);
      display.setCursor(0, 15);
      display.print("SPD:");  display.print(wheelSpeed); display.println("kmh");
      display.setCursor(0, 30);
      display.print("H2O:"); display.print(coolantTemp);display.write(247);display.println("C");
      display.setCursor(0, 45);
      display.print("GAS:");  display.print(accelPedal); display.println("%");
      break;
    case 1: {
      int x=0;
      int y = (SCREEN_HEIGHT - 64) / 2;  
      display.drawBitmap(x, y, epd_bitmap_rpm_gauge, 128, 64, SSD1306_WHITE);
      if(rpmreal > 0) {
          int width = rpmreal/62;
          if (width > 110) width = 110; 
          display.fillRect(8, 35, width, 25, WHITE);
      }
      break;
    }
    case 2: {
      display.drawRect(0, 0, 128, 64, SSD1306_WHITE);
      display.setTextSize(4);
      int xLabel = centerTextX("SPEED:", 2);
      display.setCursor(xLabel, 8);
      display.print("SPEED:");
      display.setTextSize(4);
      String spdText = String(wheelSpeed) + "kmh";
      int xValue = centerTextX(spdText, 3);
      display.setCursor(xValue, 33);
      display.print(spdText);
      break;
    }
    case 3: {
      display.drawRect(0, 0, 128, 64, SSD1306_WHITE);
      display.setTextSize(4);
      int xLabel = centerTextX("COOLANT:", 2);
      display.setCursor(xLabel, 8);
      display.print("COOLANT:");
      display.setTextSize(4);
      String tempText = String(coolantTemp) + "*C";
      int xValue = centerTextX(tempText, 3);
      display.setCursor(xValue, 33);
      display.print(coolantTemp);display.write(247);display.print("C");
      break;
    }
    case 4: {
      display.drawRect(0, 0, 128, 64, SSD1306_WHITE);
      display.setTextSize(4);
      int xLabel = centerTextX("GAS:", 2);
      display.setCursor(xLabel, 8);
      display.print("GAS:");
      display.setTextSize(4);
      String gasText = String(accelPedal) + "%";
      int xValue = centerTextX(gasText, 3);
      display.setCursor(xValue, 33);
      display.print(gasText);
      break;
    }
  } 
  display.display();
}

void updateShiftLights(int currentRpm) {
  leds.clear();
  if (currentRpm < 500) { 
    leds.show(); 
    return; 
  }
  int lit = map(currentRpm, 0, redline, 0, NUM_LEDS);
  if (lit > NUM_LEDS) lit = NUM_LEDS;
  if (currentRpm >= redline) {
    if ((millis() / flashSpeed) % 2 == 0) {
      for(int i=0; i<NUM_LEDS; i++) leds.setPixelColor(i, leds.Color(255, 255, 255));
    }
  } else {
    for(int i=0; i<lit; i++) {
      int pixelIndex = i;
      if (ledDirection == 1) {
        pixelIndex = NUM_LEDS - 1 - i;
      }
      if (i < 4) leds.setPixelColor(pixelIndex, leds.Color(0, 255, 0));
      else if (i < 8) leds.setPixelColor(pixelIndex, leds.Color(255, 255, 0));
      else leds.setPixelColor(pixelIndex, leds.Color(255, 0, 0));
    }
  }
  leds.show();
}

void startupSequence() {
  for (int i = 0; i < NUM_LEDS; i++) {
    leds.setPixelColor(i, leds.Color(50, 0, 0)); 
    leds.show();
    delay(40);
  }
  for (int x = -128; x <= 0; x += 8) {
    display.clearDisplay();
    display.drawBitmap(x, 0, logo_bmp, 128, 64, SSD1306_WHITE);
    display.display();
  }
  delay(200);
  leds.clear();
  leds.show();
  delay(1000);
  for (int x = 0; x <= 128; x += 8) {
    display.clearDisplay();
    display.drawBitmap(x, 0, logo_bmp, 128, 64, SSD1306_WHITE);
    display.display();
  }
}

void setup() {
  Serial.begin(115200);
  pinMode(ENC_CLK, INPUT_PULLUP);
  pinMode(ENC_DT, INPUT_PULLUP);
  pinMode(ENC_SW, INPUT_PULLUP);
  attachInterrupt(digitalPinToInterrupt(ENC_CLK), readEncoderISR, CHANGE);
  attachInterrupt(digitalPinToInterrupt(ENC_DT), readEncoderISR, CHANGE);
  SPI.begin(SPI_SCK, SPI_MISO, SPI_MOSI, CAN_CS);
  leds.begin();
  loadSettings();
  displayMode = 0; 
  leds.show();
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("SSD1306 allocation failed!");
    for (;;);
  }
  CAN0.reset();
  CAN0.setBitrate(CAN_500KBPS, MCP_8MHZ);
  CAN0.setNormalMode();
  startupSequence();
}

int rpmfals = 0;
int spdfals = 0;
int tempfals = 0;
int gasfals = 0;
int i = 1;        
int direction = 1; 
unsigned long lastFakeUpdate = 0;
const unsigned long fakeInterval = 2; 

void loop() {
  int currentPos = encoderRawValue / 4; 
  if (currentPos != lastEncoderValue) {
    int delta = currentPos - lastEncoderValue;
    lastEncoderValue = currentPos;
    if (currentState == STATE_MAIN) {
      displayMode += delta;
      if (displayMode > 4) displayMode = 0; 
      if (displayMode < 0) displayMode = 4;
    }
    else if (currentState == STATE_SET_REDLINE) {
      redline += (delta * 100); 
      if (redline < 1000) redline = 1000;
      if (redline > 12000) redline = 12000;
    }
    else if (currentState == STATE_SET_BRIGHTNESS) {
      ledBrightness += (delta * 5); 
      if (ledBrightness < 5) ledBrightness = 5;
      if (ledBrightness > 255) ledBrightness = 255;
      leds.setBrightness(ledBrightness); 
      leds.show();
    }
    else if (currentState == STATE_SET_DIRECTION) {
      if (delta > 0) ledDirection = 1;
      else ledDirection = 0;
    }
    else if (currentState == STATE_SET_FLASH) {
      flashSpeed += (delta * 10); 
      if (flashSpeed < 10) flashSpeed = 10; 
      if (flashSpeed > 500) flashSpeed = 500; 
    }
  }

  if (digitalRead(ENC_SW) == LOW) {
    if (buttonDownTime == 0) {
       buttonDownTime = millis();
       isLongPressHandled = false;
    }
    if (millis() - buttonDownTime > longPressDuration && !isLongPressHandled) {
       display.clearDisplay();
       display.setTextColor(SSD1306_WHITE);
       display.setTextSize(3);
       int xLabel = centerTextX("RESET...", 2); 
       display.setCursor(xLabel, 24);
       display.print("RESET...");
       display.display();
       delay(1000);
       ESP.restart();
       isLongPressHandled = true;
    }
  } else {
    if (buttonDownTime != 0) {
      if (millis() - buttonDownTime < longPressDuration && !isLongPressHandled) {
          if (millis() - lastMenuActionTime > 200) {
              lastMenuActionTime = millis();
              switch (currentState) {
                case STATE_MAIN: currentState = STATE_SET_REDLINE; break;
                case STATE_SET_REDLINE: saveSettings(); currentState = STATE_SET_BRIGHTNESS; break;
                case STATE_SET_BRIGHTNESS: saveSettings(); currentState = STATE_SET_DIRECTION; break;
                case STATE_SET_DIRECTION: saveSettings(); currentState = STATE_SET_FLASH; break;
                case STATE_SET_FLASH: saveSettings(); currentState = STATE_MAIN; break;
              }
          }
      }
      buttonDownTime = 0;
    }
  }

  while (CAN0.readMessage(&canMsg) == MCP2515::ERROR_OK) {
    lastCANtime = millis();
    if (canMsg.can_id == RPM_CAN_ID && canMsg.can_dlc >= 3) {
      rpm = (canMsg.data[1] << 8) | canMsg.data[2];
      rpmreal = rpm / 4;
    } else if (canMsg.can_id == WHEEL_CAN_ID && canMsg.can_dlc >= 8) {
      float w1 = ((canMsg.data[0] << 8) | canMsg.data[1]) * 0.0276923;
      float w2 = ((canMsg.data[2] << 8) | canMsg.data[3]) * 0.0276923;
      wheelSpeed = (w1 + w2) / 2;
    } else if (canMsg.can_id == COOLANT_CAN_ID && canMsg.can_dlc >= 2) {
      coolantTemp = canMsg.data[1] - 40;
    } else if (canMsg.can_id == ACCEL_CAN_ID && canMsg.can_dlc >= 2) {
      accelPedal = canMsg.data[1] * 100.0 / 255.0;
    }
  }

  if (millis() - lastFakeUpdate >= fakeInterval) {
    lastFakeUpdate = millis();
    i += direction; 
    if (i >= (redline + 500)) direction = -1; 
    if (i <= 0) direction = 1;
    rpmfals  = i;
    spdfals  = i / 35;  
    tempfals = i / 77;
    gasfals  = i / 70;
  }

  if (millis() - lastDisplayUpdate >= displayInterval) {
    lastDisplayUpdate = millis();
    if (currentState != STATE_MAIN) {
      showMenu();
      if (currentState == STATE_SET_BRIGHTNESS || currentState == STATE_SET_DIRECTION) {
         updateShiftLights(redline - 500); 
      } else if (currentState == STATE_SET_FLASH) {
         updateShiftLights(redline + 100); 
      } else {
         leds.clear(); leds.show(); 
      }
    } 
    else {
      if (millis() - lastCANtime > 5000) {
        showDisplay(rpmfals, spdfals, tempfals, gasfals); 
        updateShiftLights(rpmfals); 
      } else {
        showDisplay(rpmreal, wheelSpeed, coolantTemp, accelPedal);
        updateShiftLights(rpmreal); 
      }
    }
  }
}
